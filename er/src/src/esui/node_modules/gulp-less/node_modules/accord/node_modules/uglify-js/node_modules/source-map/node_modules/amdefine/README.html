<h1 id="amdefine">amdefine</h1><p>A module that can be used to implement AMD’s define() in Node. This allows you<br>to code to the AMD API and have the module work in node programs without<br>requiring those other programs to use AMD.</p>
<h2 id="Usage">Usage</h2><p><strong>1)</strong> Update your package.json to indicate amdefine as a dependency:</p>
<pre><code class="javascript"><span class="string">"dependencies"</span>: {
    <span class="string">"amdefine"</span>: <span class="string">"&gt;=0.1.0"</span>
}
</code></pre>
<p>Then run <code>npm install</code> to get amdefine into your project.</p>
<p><strong>2)</strong> At the top of each module that uses define(), place this code:</p>
<pre><code class="javascript"><span class="keyword">if</span> (<span class="keyword">typeof</span> define !== <span class="string">'function'</span>) { <span class="keyword">var</span> define = <span class="built_in">require</span>(<span class="string">'amdefine'</span>)(<span class="built_in">module</span>) }
</code></pre>
<p><strong>Only use these snippets</strong> when loading amdefine. If you preserve the basic structure,<br>with the braces, it will be stripped out when using the <a href="#optimizer">RequireJS optimizer</a>.</p>
<p>You can add spaces, line breaks and even require amdefine with a local path, but<br>keep the rest of the structure to get the stripping behavior.</p>
<p>As you may know, because <code>if</code> statements in JavaScript don’t have their own scope, the var<br>declaration in the above snippet is made whether the <code>if</code> expression is truthy or not. If<br>RequireJS is loaded then the declaration is superfluous because <code>define</code> is already already<br>declared in the same scope in RequireJS. Fortunately JavaScript handles multiple <code>var</code><br>declarations of the same variable in the same scope gracefully.</p>
<p>If you want to deliver amdefine.js with your code rather than specifying it as a dependency<br>with npm, then just download the latest release and refer to it using a relative path:</p>
<p><a href="https://github.com/jrburke/amdefine/raw/latest/amdefine.js">Latest Version</a></p>
<h3 id="amdefine/intercept">amdefine/intercept</h3><p>Consider this very experimental.</p>
<p>Instead of pasting the piece of text for the amdefine setup of a <code>define</code><br>variable in each module you create or consume, you can use <code>amdefine/intercept</code><br>instead. It will automatically insert the above snippet in each .js file loaded<br>by Node.</p>
<p><strong>Warning</strong>: you should only use this if you are creating an application that<br>is consuming AMD style defined()’d modules that are distributed via npm and want<br>to run that code in Node.</p>
<p>For library code where you are not sure if it will be used by others in Node or<br>in the browser, then explicitly depending on amdefine and placing the code<br>snippet above is suggested path, instead of using <code>amdefine/intercept</code>. The<br>intercept module affects all .js files loaded in the Node app, and it is<br>inconsiderate to modify global state like that unless you are also controlling<br>the top level app.</p>
<h4 id="Why_distribute_AMD-style_nodes_via_npm?">Why distribute AMD-style nodes via npm?</h4><p>npm has a lot of weaknesses for front-end use (installed layout is not great,<br>should have better support for the `baseUrl + moduleID + ‘.js’ style of loading,<br>single file JS installs), but some people want a JS package manager and are<br>willing to live with those constraints. If that is you, but still want to author<br>in AMD style modules to get dynamic require([]), better direct source usage and<br>powerful loader plugin support in the browser, then this tool can help.</p>
<h4 id="amdefine/intercept_usage">amdefine/intercept usage</h4><p>Just require it in your top level app module (for example index.js, server.js):</p>
<pre><code class="javascript"><span class="built_in">require</span>(<span class="string">'amdefine/intercept'</span>);
</code></pre>
<p>The module does not return a value, so no need to assign the result to a local<br>variable.</p>
<p>Then just require() code as you normally would with Node’s require(). Any .js<br>loaded after the intercept require will have the amdefine check injected in<br>the .js source as it is loaded. It does not modify the source on disk, just<br>prepends some content to the text of the module as it is loaded by Node.</p>
<h4 id="How_amdefine/intercept_works">How amdefine/intercept works</h4><p>It overrides the <code>Module._extensions[&#39;.js&#39;]</code> in Node to automatically prepend<br>the amdefine snippet above. So, it will affect any .js file loaded by your<br>app.</p>
<h2 id="define()_usage">define() usage</h2><p>It is best if you use the anonymous forms of define() in your module:</p>
<pre><code class="javascript">define(<span class="function"><span class="keyword">function</span> (<span class="params">require</span>) </span>{
    <span class="keyword">var</span> dependency = <span class="built_in">require</span>(<span class="string">'dependency'</span>);
});
</code></pre>
<p>or</p>
<pre><code class="javascript">define([<span class="string">'dependency'</span>], <span class="function"><span class="keyword">function</span> (<span class="params">dependency</span>) </span>{

});
</code></pre>
<h2 id="RequireJS_optimizer_integration-">RequireJS optimizer integration. <a name="optimizer"></name></h2><p>Version 1.0.3 of the <a href="http://requirejs.org/docs/optimization.html">RequireJS optimizer</a><br>will have support for stripping the <code>if (typeof define !== &#39;function&#39;)</code> check<br>mentioned above, so you can include this snippet for code that runs in the<br>browser, but avoid taking the cost of the if() statement once the code is<br>optimized for deployment.</p>
<h2 id="Node_0-4_Support">Node 0.4 Support</h2><p>If you want to support Node 0.4, then add <code>require</code> as the second parameter to amdefine:</p>
<pre><code class="javascript"><span class="comment">//Only if you want Node 0.4. If using 0.5 or later, use the above snippet.</span>
<span class="keyword">if</span> (<span class="keyword">typeof</span> define !== <span class="string">'function'</span>) { <span class="keyword">var</span> define = <span class="built_in">require</span>(<span class="string">'amdefine'</span>)(<span class="built_in">module</span>, <span class="built_in">require</span>) }
</code></pre>
<h2 id="Limitations">Limitations</h2><h3 id="Synchronous_vs_Asynchronous">Synchronous vs Asynchronous</h3><p>amdefine creates a define() function that is callable by your code. It will<br>execute and trace dependencies and call the factory function <em>synchronously</em>,<br>to keep the behavior in line with Node’s synchronous dependency tracing.</p>
<p>The exception: calling AMD’s callback-style require() from inside a factory<br>function. The require callback is called on process.nextTick():</p>
<pre><code class="javascript">define(<span class="function"><span class="keyword">function</span> (<span class="params">require</span>) </span>{
    <span class="built_in">require</span>([<span class="string">'a'</span>], <span class="function"><span class="keyword">function</span>(<span class="params">a</span>) </span>{
        <span class="comment">//'a' is loaded synchronously, but</span>
        <span class="comment">//this callback is called on process.nextTick().</span>
    });
});
</code></pre>
<h3 id="Loader_Plugins">Loader Plugins</h3><p>Loader plugins are supported as long as they call their load() callbacks<br>synchronously. So ones that do network requests will not work. However plugins<br>like <a href="http://requirejs.org/docs/api.html#text">text</a> can load text files locally.</p>
<p>The plugin API’s <code>load.fromText()</code> is <strong>not supported</strong> in amdefine, so this means<br>transpiler plugins like the <a href="https://github.com/jrburke/require-cs">CoffeeScript loader plugin</a><br>will not work. This may be fixable, but it is a bit complex, and I do not have<br>enough node-fu to figure it out yet. See the source for amdefine.js if you want<br>to get an idea of the issues involved.</p>
<h2 id="Tests">Tests</h2><p>To run the tests, cd to <strong>tests</strong> and run:</p>
<pre><code><span class="keyword">node</span> <span class="literal">all</span>.js
<span class="keyword">node</span> <span class="literal">all</span>-intercept.js
</code></pre><h2 id="License">License</h2><p>New BSD and MIT. Check the LICENSE file for all the details.</p>
