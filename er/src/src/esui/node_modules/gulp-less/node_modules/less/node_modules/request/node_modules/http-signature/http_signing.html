<h1 id="Abstract">Abstract</h1><p>This document describes a way to add origin authentication, message integrity,<br>and replay resistance to HTTP REST requests.  It is intended to be used over<br>the HTTPS protocol.</p>
<h1 id="Copyright_Notice">Copyright Notice</h1><p>Copyright (c) 2011 Joyent, Inc. and the persons identified as document authors.<br>All rights reserved.</p>
<p>Code Components extracted from this document must include MIT License text.</p>
<h1 id="Introduction">Introduction</h1><p>This protocol is intended to provide a standard way for clients to sign HTTP<br>requests.  RFC2617 (HTTP Authentication) defines Basic and Digest authentication<br>mechanisms, and RFC5246 (TLS 1.2) defines client-auth, both of which are widely<br>employed on the Internet today.  However, it is common place that the burdens of<br>PKI prevent web service operators from deploying that methodology, and so many<br>fall back to Basic authentication, which has poor security characteristics.</p>
<p>Additionally, OAuth provides a fully-specified alternative for authorization<br>of web service requests, but is not (always) ideal for machine to machine<br>communication, as the key acquisition steps (generally) imply a fixed<br>infrastructure that may not make sense to a service provider (e.g., symmetric<br>keys).</p>
<p>Several web service providers have invented their own schemes for signing<br>HTTP requests, but to date, none have been placed in the public domain as a<br>standard.  This document serves that purpose.  There are no techniques in this<br>proposal that are novel beyond previous art, however, this aims to be a simple<br>mechanism for signing these requests.</p>
<h1 id="Signature_Authentication_Scheme">Signature Authentication Scheme</h1><p>The “signature” authentication scheme is based on the model that the client must<br>authenticate itself with a digital signature produced by either a private<br>asymmetric key (e.g., RSA) or a shared symmetric key (e.g., HMAC).  The scheme<br>is parameterized enough such that it is not bound to any particular key type or<br>signing algorithm.  However, it does explicitly assume that clients can send an<br>HTTP <code>Date</code> header.</p>
<h2 id="Authorization_Header">Authorization Header</h2><p>The client is expected to send an Authorization header (as defined in RFC 2617)<br>with the following parameterization:</p>
<pre><code><span class="string">credentials :</span>= <span class="string">"Signature"</span> params
<span class="string">params :</span>= <span class="number">1</span>#(keyId | algorithm | [headers] | [ext] | signature)
<span class="string">digitalSignature :</span>= plain-string

<span class="string">keyId :</span>= <span class="string">"keyId"</span> <span class="string">"="</span> &lt;<span class="string">"&gt; plain-string &lt;"</span>&gt;
<span class="string">algorithm :</span>= <span class="string">"algorithm"</span> <span class="string">"="</span> &lt;<span class="string">"&gt; plain-string &lt;"</span>&gt;
<span class="string">headers :</span>= <span class="string">"headers"</span> <span class="string">"="</span> &lt;<span class="string">"&gt; 1#headers-value &lt;"</span>&gt;
<span class="string">ext :</span>= <span class="string">"ext"</span> <span class="string">"="</span> &lt;<span class="string">"&gt; plain-string &lt;"</span>&gt;
<span class="string">signature :</span>= <span class="string">"signature"</span> <span class="string">"="</span> &lt;<span class="string">"&gt; plain-string &lt;"</span>&gt;

headers-<span class="string">value :</span>= plain-string
plain-string   = <span class="number">1</span>*( %x20-<span class="number">21</span> <span class="regexp">/ %x23-5B /</span> %x5D-<span class="number">7</span>E )
</code></pre><h3 id="Signature_Parameters">Signature Parameters</h3><h4 id="keyId">keyId</h4><p>REQUIRED.  The <code>keyId</code> field is an opaque string that the server can use to look<br>up the component they need to validate the signature.  It could be an SSH key<br>fingerprint, an LDAP DN, etc.  Management of keys and assignment of <code>keyId</code> is<br>out of scope for this document.</p>
<h4 id="algorithm">algorithm</h4><p>REQUIRED. The <code>algorithm</code> parameter is used if the client and server agree on a<br>non-standard digital signature algorithm.  The full list of supported signature<br>mechanisms is listed below.</p>
<h4 id="headers">headers</h4><p>OPTIONAL.  The <code>headers</code> parameter is used to specify the list of HTTP headers<br>used to sign the request.  If specified, it should be a quoted list of HTTP<br>header names, separated by a single space character.  By default, only one<br>HTTP header is signed, which is the <code>Date</code> header.  Note that the list MUST be<br>specified in the order the values are concatenated together during signing. To<br>include the HTTP request line in the signature calculation, use the special<br><code>request-line</code> value.  While this is overloading the definition of <code>headers</code> in<br>HTTP linguism, the request-line is defined in RFC 2616, and as the outlier from<br>headers in useful signature calculation, it is deemed simpler to simply use<br><code>request-line</code> than to add a separate parameter for it.</p>
<h4 id="extensions">extensions</h4><p>OPTIONAL.  The <code>extensions</code> parameter is used to include additional information<br>which is covered by the request.  The content and format of the string is out of<br>scope for this document, and expected to be specified by implementors.</p>
<h4 id="signature">signature</h4><p>REQUIRED.  The <code>signature</code> parameter is a <code>Base64</code> encoded digital signature<br>generated by the client. The client uses the <code>algorithm</code> and <code>headers</code> request<br>parameters to form a canonicalized <code>signing string</code>.  This <code>signing string</code> is<br>then signed with the key associated with <code>keyId</code> and the algorithm<br>corresponding to <code>algorithm</code>.  The <code>signature</code> parameter is then set to the<br><code>Base64</code> encoding of the signature.</p>
<h3 id="Signing_String_Composition">Signing String Composition</h3><p>In order to generate the string that is signed with a key, the client MUST take<br>the values of each HTTP header specified by <code>headers</code> in the order they appear.</p>
<ol>
<li>If the header name is not <code>request-line</code> then append the lowercased header<br>name followed with an ASCII colon <code>:</code> and an ASCII space <code> </code>.</li>
<li>If the header name is <code>request-line</code> then append the HTTP request line,<br>otherwise append the header value.</li>
<li>If value is not the last value then append an ASCII newline <code>\n</code>. The string<br>MUST NOT include a trailing ASCII newline.</li>
</ol>
<h1 id="Example_Requests">Example Requests</h1><p>All requests refer to the following request (body omitted):</p>
<pre><code><span class="request">POST <span class="string">/foo</span> HTTP/1.1</span>
<span class="attribute">Host</span>: <span class="string">example.org</span>
<span class="attribute">Date</span>: <span class="string">Tue, 07 Jun 2011 20:51:35 GMT</span>
<span class="attribute">Content-Type</span>: <span class="string">application/json</span>
<span class="attribute">Content-MD5</span>: <span class="string">h0auK8hnYJKmHTLhKtMTkQ==</span>
<span class="attribute">Content-Length</span>: <span class="string">123</span>
</code></pre><p>The “rsa-key-1” keyId refers to a private key known to the client and a public<br>key known to the server. The “hmac-key-1” keyId refers to key known to the<br>client and server.</p>
<h2 id="Default_parameterization">Default parameterization</h2><p>The authorization header and signature would be generated as:</p>
<pre><code>Authorization: Signature <span class="variable">keyId=</span><span class="string">"rsa-key-1"</span>,<span class="variable">algorithm=</span><span class="string">"rsa-sha256"</span>,<span class="variable">signature=</span><span class="string">"Base64(RSA-SHA256(signing string))"</span>
</code></pre><p>The client would compose the signing string as:</p>
<pre><code><span class="attribute">date</span>: <span class="string">Tue, 07 Jun 2011 20:51:35 GMT</span>
</code></pre><h2 id="Header_List">Header List</h2><p>The authorization header and signature would be generated as:</p>
<pre><code>Authorization: Signature <span class="variable">keyId=</span><span class="string">"rsa-key-1"</span>,<span class="variable">algorithm=</span><span class="string">"rsa-sha256"</span>,<span class="variable">headers=</span><span class="string">"request-line date content-type content-md5"</span>,<span class="variable">signature=</span><span class="string">"Base64(RSA-SHA256(signing string))"</span>
</code></pre><p>The client would compose the signing string as (<code>+ &quot;\n&quot;</code> inserted for<br>readability):</p>
<pre><code>POST <span class="regexp">/foo HTTP/</span><span class="number">1.1</span> + <span class="string">"\n"</span>
<span class="string">date:</span> Tue, <span class="number">07</span> Jun <span class="number">2011</span> <span class="number">20</span>:<span class="number">51</span>:<span class="number">35</span> GMT + <span class="string">"\n"</span>
content-<span class="string">type:</span> application/json + <span class="string">"\n"</span>
content-<span class="string">md5:</span> h0auK8hnYJKmHTLhKtMTkQ==
</code></pre><h2 id="Algorithm">Algorithm</h2><p>The authorization header and signature would be generated as:</p>
<pre><code>Authorization: Signature <span class="variable">keyId=</span><span class="string">"hmac-key-1"</span>,<span class="variable">algorithm=</span><span class="string">"hmac-sha1"</span>,<span class="variable">signature=</span><span class="string">"Base64(HMAC-SHA1(signing string))"</span>
</code></pre><p>The client would compose the signing string as:</p>
<pre><code><span class="attribute">date</span>: <span class="string">Tue, 07 Jun 2011 20:51:35 GMT</span>
</code></pre><h1 id="Signing_Algorithms">Signing Algorithms</h1><p>Currently supported algorithm names are:</p>
<ul>
<li>rsa-sha1</li>
<li>rsa-sha256</li>
<li>rsa-sha512</li>
<li>dsa-sha1</li>
<li>hmac-sha1</li>
<li>hmac-sha256</li>
<li>hmac-sha512</li>
</ul>
<h1 id="Security_Considerations">Security Considerations</h1><h2 id="Default_Parameters">Default Parameters</h2><p>Note the default parameterization of the <code>Signature</code> scheme is only safe if all<br>requests are carried over a secure transport (i.e., TLS).  Sending the default<br>scheme over a non-secure transport will leave the request vulnerable to<br>spoofing, tampering, replay/repudiation, and integrity violations (if using the<br>STRIDE threat-modeling methodology).</p>
<h2 id="Insecure_Transports">Insecure Transports</h2><p>If sending the request over plain HTTP, service providers SHOULD require clients<br>to sign ALL HTTP headers, and the <code>request-line</code>.  Additionally, service<br>providers SHOULD require <code>Content-MD5</code> calculations to be performed to ensure<br>against any tampering from clients.</p>
<h2 id="Nonces">Nonces</h2><p>Nonces are out of scope for this document simply because many service providers<br>fail to implement them correctly, or do not adopt security specifications<br>because of the infrastructure complexity.  Given the <code>header</code> parameterization,<br>a service provider is fully enabled to add nonce semantics into this scheme by<br>using something like an <code>x-request-nonce</code> header, and ensuring it is signed<br>with the <code>Date</code> header.</p>
<h2 id="Clock_Skew">Clock Skew</h2><p>As the default scheme is to sign the <code>Date</code> header, service providers SHOULD<br>protect against logged replay attacks by enforcing a clock skew.  The server<br>SHOULD be synchronized with NTP, and the recommendation in this specification<br>is to allow 300s of clock skew (in either direction).</p>
<h2 id="Required_Headers_to_Sign">Required Headers to Sign</h2><p>It is out of scope for this document to dictate what headers a service provider<br>will want to enforce, but service providers SHOULD at minimum include the<br><code>Date</code> header.</p>
<h1 id="References">References</h1><h2 id="Normative_References">Normative References</h2><ul>
<li>[RFC2616] Hypertext Transfer Protocol — HTTP/1.1</li>
<li>[RFC2617] HTTP Authentication: Basic and Digest Access Authentication</li>
<li>[RFC5246] The Transport Layer Security (TLS) Protocol Version 1.2</li>
</ul>
<h2 id="Informative_References">Informative References</h2><pre><code><span class="attribute">Name</span>: Mark Cavage (editor)
<span class="attribute">Company</span>: Joyent, Inc.
<span class="attribute">Email</span>: mark.cavage<span class="variable">@joyent</span>.com
<span class="attribute">URI</span>: <span class="attribute">http</span>:<span class="comment">//www.joyent.com</span>
</code></pre><h1 id="Appendix_A_-_Test_Values">Appendix A - Test Values</h1><p>The following test data uses the RSA (2048b) keys, which we will refer<br>to as <code>keyId=Test</code> in the following samples:</p>
<pre><code>-----BEGIN <span class="keyword">PUBLIC</span> <span class="keyword">KEY</span>-----
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCFENGw33yGihy92pDjZQhl0C3
<span class="number">6</span>rPJj+CvfSC8+q28hxA161QFNUd13wuCTUcq0Qd2qsBe/<span class="number">2</span>hFyc2DCJJg0h1L78+<span class="number">6</span>
Z4UMR7EOcpfdUE9Hf3m/hs+FUR45uBJeDK1HSFHD8bHKD6kv8FPGfJTotc+<span class="number">2</span>xjJw
oYi+<span class="number">1</span>hqp1fIekaxsyQIDAQAB
-----<span class="keyword">END</span> <span class="keyword">PUBLIC</span> <span class="keyword">KEY</span>-----

-----BEGIN RSA <span class="keyword">PRIVATE</span> <span class="keyword">KEY</span>-----
MIICXgIBAAKBgQDCFENGw33yGihy92pDjZQhl0C36rPJj+CvfSC8+q28hxA161QF
NUd13wuCTUcq0Qd2qsBe/<span class="number">2</span>hFyc2DCJJg0h1L78+<span class="number">6</span>Z4UMR7EOcpfdUE9Hf3m/hs+F
UR45uBJeDK1HSFHD8bHKD6kv8FPGfJTotc+<span class="number">2</span>xjJwoYi+<span class="number">1</span>hqp1fIekaxsyQIDAQAB
AoGBAJR8ZkCUvx5kzv+utdl7T5MnordT1TvoXXJGXK7ZZ+UuvMNUCdN2QPc4sBiA
QWvLw1cSKt5DsKZ8UETpYPy8pPYnnDEz2dDYiaew9+xEpubyeW2oH4Zx71wqBtOK
kqwrXa/pzdpiucRRjk6vE6YY7EBBs/g7uanVpGibOVAEsqH1AkEA7DkjVH28WDUg
f1nqvfn2Kj6CT7nIcE3jGJsZZ7zlZmBmHFDONMLUrXR/Zm3pR5m0tCmBqa5RK95u
<span class="number">412</span>jt1dPIwJBANJT3v8pnkth48bQo/fKel6uEYyboRtA5/uHuHkZ6FQF7OUkGogc
mSJluOdc5t6hI1VsLn0QZEjQZMEOWr+wKSMCQQCC4kXJEsHAve77oP6HtG/IiEn7
kpyUXRNvFsDE0czpJJBvL/aRFUJxuRK91jhjC68sA7NsKMGg5OXb5I5Jj36xAkEA
gIT7aFOYBFwGgQAQkWNKLvySgKbAZRTeLBacpHMuQdl1DfdntvAyqpAZ0lY0RKmW
G6aFKaqQfOXKCyWoUiVknQJAXrlgySFci/<span class="number">2</span>ueKlIE1QqIiLSZ8V8OlpFLRnb1pzI
<span class="number">7</span>U1yQXnTAEFYM560yJlzUpOb1V4cScGd365tiSMvxLOvTA==
-----<span class="keyword">END</span> RSA <span class="keyword">PRIVATE</span> <span class="keyword">KEY</span>-----
</code></pre><p>And all examples use this request:</p>
<pre><code><span class="request">POST <span class="string">/foo?param=value&amp;pet=dog</span> HTTP/1.1</span>
<span class="attribute">Host</span>: <span class="string">example.com</span>
<span class="attribute">Date</span>: <span class="string">Thu, 05 Jan 2012 21:31:40 GMT</span>
<span class="attribute">Content-Type</span>: <span class="string">application/json</span>
<span class="attribute">Content-MD5</span>: <span class="string">Sd/dVLAcvNLSq16eXua5uQ==</span>
<span class="attribute">Content-Length</span>: <span class="string">18</span>

<span class="json">{"<span class="attribute">hello</span>": <span class="value"><span class="string">"world"</span></span>}</span>
</code></pre><h3 id="Default">Default</h3><p>The string to sign would be:</p>
<pre><code><span class="attribute">date</span>: <span class="string">Thu, 05 Jan 2012 21:31:40 GMT</span>
</code></pre><p>The Authorization header would be:</p>
<pre><code>Authorization: Signature <span class="variable">keyId=</span><span class="string">"Test"</span>,<span class="variable">algorithm=</span><span class="string">"rsa-sha256"</span>,<span class="variable">signature=</span><span class="string">"ATp0r26dbMIxOopqw0OfABDT7CKMIoENumuruOtarj8n/97Q3htHFYpH8yOSQk3Z5zh8UxUym6FYTb5+A0Nz3NRsXJibnYi7brE/4tx5But9kkFGzG+xpUmimN4c3TMN7OFH//+r8hBf7BT9/GmHDUVZT2JzWGLZES2xDOUuMtA="</span>
</code></pre><h3 id="All_Headers">All Headers</h3><p>Parameterized to include all headers, the string to sign would be (<code>+ &quot;\n&quot;</code><br>inserted for readability):</p>
<pre><code>POST <span class="regexp">/foo?param=value&amp;pet=dog HTTP/</span><span class="number">1.1</span> + <span class="string">"\n"</span>
<span class="string">host:</span> example.com + <span class="string">"\n"</span>
<span class="string">date:</span> Thu, <span class="number">05</span> Jan <span class="number">2012</span> <span class="number">21</span>:<span class="number">31</span>:<span class="number">40</span> GMT + <span class="string">"\n"</span>
content-<span class="string">type:</span> application/json + <span class="string">"\n"</span>
content-<span class="string">md5:</span> Sd/dVLAcvNLSq16eXua5uQ== + <span class="string">"\n"</span>
content-<span class="string">length:</span> <span class="number">18</span>
</code></pre><p>The Authorization header would be:</p>
<pre><code>Authorization: Signature <span class="variable">keyId=</span><span class="string">"Test"</span>,<span class="variable">algorithm=</span><span class="string">"rsa-sha256"</span>,<span class="variable">headers=</span><span class="string">"request-line host date content-type content-md5 content-length"</span>,<span class="variable">signature=</span><span class="string">"H/AaTDkJvLELy4i1RujnKlS6dm8QWiJvEpn9cKRMi49kKF+mohZ15z1r+mF+XiKS5kOOscyS83olfBtsVhYjPg2Ei3/D9D4Mvb7bFm9IaLJgYTFFuQCghrKQQFPiqJN320emjHxFowpIm1BkstnEU7lktH/XdXVBo8a6Uteiztw="</span>
</code></pre>