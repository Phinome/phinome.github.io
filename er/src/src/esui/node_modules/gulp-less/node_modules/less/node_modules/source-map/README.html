<h1 id="Source_Map">Source Map</h1><p>This is a library to generate and consume the source map format<br><a href="https://docs.google.com/document/d/1U1RGAehQwRypUTovF1KRlpiOFze0b-_2gc6fAH0KY0k/edit">described here</a>.</p>
<p>This library is written in the Asynchronous Module Definition format, and works<br>in the following environments:</p>
<ul>
<li><p>Modern Browsers supporting ECMAScript 5 (either after the build, or with an<br>AMD loader such as RequireJS)</p>
</li>
<li><p>Inside Firefox (as a JSM file, after the build)</p>
</li>
<li><p>With NodeJS versions 0.8.X and higher</p>
</li>
</ul>
<h2 id="Node">Node</h2><pre><code>$ npm install <span class="keyword">source</span>-<span class="built_in">map</span>
</code></pre><h2 id="Building_from_Source_(for_everywhere_else)">Building from Source (for everywhere else)</h2><p>Install Node and then run</p>
<pre><code>$ git clone http<span class="variable">s:</span>//fitzgen@github.<span class="keyword">com</span>/mozilla/<span class="keyword">source</span>-<span class="built_in">map</span>.git
$ <span class="keyword">cd</span> <span class="keyword">source</span>-<span class="built_in">map</span>
$ npm link .
</code></pre><p>Next, run</p>
<pre><code>$ node Makefile<span class="class">.dryice</span><span class="class">.js</span>
</code></pre><p>This should spew a bunch of stuff to stdout, and create the following files:</p>
<ul>
<li><p><code>dist/source-map.js</code> - The unminified browser version.</p>
</li>
<li><p><code>dist/source-map.min.js</code> - The minified browser version.</p>
</li>
<li><p><code>dist/SourceMap.jsm</code> - The JavaScript Module for inclusion in Firefox source.</p>
</li>
</ul>
<h2 id="Examples">Examples</h2><h3 id="Consuming_a_source_map">Consuming a source map</h3><pre><code class="js"><span class="keyword">var</span> rawSourceMap = {
  version: <span class="number">3</span>,
  file: <span class="string">'min.js'</span>,
  names: [<span class="string">'bar'</span>, <span class="string">'baz'</span>, <span class="string">'n'</span>],
  sources: [<span class="string">'one.js'</span>, <span class="string">'two.js'</span>],
  sourceRoot: <span class="string">'http://example.com/www/js/'</span>,
  mappings: <span class="string">'CAAC,IAAI,IAAM,SAAUA,GAClB,OAAOC,IAAID;CCDb,IAAI,IAAM,SAAUE,GAClB,OAAOA'</span>
};

<span class="keyword">var</span> smc = <span class="keyword">new</span> SourceMapConsumer(rawSourceMap);

<span class="built_in">console</span>.log(smc.sources);
<span class="comment">// [ 'http://example.com/www/js/one.js',</span>
<span class="comment">//   'http://example.com/www/js/two.js' ]</span>

<span class="built_in">console</span>.log(smc.originalPositionFor({
  line: <span class="number">2</span>,
  column: <span class="number">28</span>
}));
<span class="comment">// { source: 'http://example.com/www/js/two.js',</span>
<span class="comment">//   line: 2,</span>
<span class="comment">//   column: 10,</span>
<span class="comment">//   name: 'n' }</span>

<span class="built_in">console</span>.log(smc.generatedPositionFor({
  source: <span class="string">'http://example.com/www/js/two.js'</span>,
  line: <span class="number">2</span>,
  column: <span class="number">10</span>
}));
<span class="comment">// { line: 2, column: 28 }</span>

smc.eachMapping(<span class="function"><span class="keyword">function</span> (<span class="params">m</span>) </span>{
  <span class="comment">// ...</span>
});
</code></pre>
<h3 id="Generating_a_source_map">Generating a source map</h3><p>In depth guide:<br><a href="https://hacks.mozilla.org/2013/05/compiling-to-javascript-and-debugging-with-source-maps/"><strong>Compiling to JavaScript, and Debugging with Source Maps</strong></a></p>
<h4 id="With_SourceNode_(high_level_API)">With SourceNode (high level API)</h4><pre><code class="js"><span class="function"><span class="keyword">function</span> <span class="title">compile</span>(<span class="params">ast</span>) </span>{
  <span class="keyword">switch</span> (ast.type) {
  <span class="keyword">case</span> <span class="string">'BinaryExpression'</span>:
    <span class="keyword">return</span> <span class="keyword">new</span> SourceNode(
      ast.location.line,
      ast.location.column,
      ast.location.source,
      [compile(ast.left), <span class="string">" + "</span>, compile(ast.right)]
    );
  <span class="keyword">case</span> <span class="string">'Literal'</span>:
    <span class="keyword">return</span> <span class="keyword">new</span> SourceNode(
      ast.location.line,
      ast.location.column,
      ast.location.source,
      <span class="built_in">String</span>(ast.value)
    );
  <span class="comment">// ...</span>
  <span class="keyword">default</span>:
    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Bad AST"</span>);
  }
}

<span class="keyword">var</span> ast = parse(<span class="string">"40 + 2"</span>, <span class="string">"add.js"</span>);
<span class="built_in">console</span>.log(compile(ast).toStringWithSourceMap({
  file: <span class="string">'add.js'</span>
}));
<span class="comment">// { code: '40 + 2',</span>
<span class="comment">//   map: [object SourceMapGenerator] }</span>
</code></pre>
<h4 id="With_SourceMapGenerator_(low_level_API)">With SourceMapGenerator (low level API)</h4><pre><code class="js"><span class="keyword">var</span> map = <span class="keyword">new</span> SourceMapGenerator({
  file: <span class="string">"source-mapped.js"</span>
});

map.addMapping({
  generated: {
    line: <span class="number">10</span>,
    column: <span class="number">35</span>
  },
  source: <span class="string">"foo.js"</span>,
  original: {
    line: <span class="number">33</span>,
    column: <span class="number">2</span>
  },
  name: <span class="string">"christopher"</span>
});

<span class="built_in">console</span>.log(map.toString());
<span class="comment">// '{"version":3,"file":"source-mapped.js","sources":["foo.js"],"names":["christopher"],"mappings":";;;;;;;;;mCAgCEA"}'</span>
</code></pre>
<h2 id="API">API</h2><p>Get a reference to the module:</p>
<pre><code class="js"><span class="comment">// NodeJS</span>
<span class="keyword">var</span> sourceMap = <span class="built_in">require</span>(<span class="string">'source-map'</span>);

<span class="comment">// Browser builds</span>
<span class="keyword">var</span> sourceMap = <span class="built_in">window</span>.sourceMap;

<span class="comment">// Inside Firefox</span>
<span class="keyword">let</span> sourceMap = {};
Components.utils.import(<span class="string">'resource:///modules/devtools/SourceMap.jsm'</span>, sourceMap);
</code></pre>
<h3 id="SourceMapConsumer">SourceMapConsumer</h3><p>A SourceMapConsumer instance represents a parsed source map which we can query<br>for information about the original file positions by giving it a file position<br>in the generated source.</p>
<h4 id="new_SourceMapConsumer(rawSourceMap)">new SourceMapConsumer(rawSourceMap)</h4><p>The only parameter is the raw source map (either as a string which can be<br><code>JSON.parse</code>‘d, or an object). According to the spec, source maps have the<br>following attributes:</p>
<ul>
<li><p><code>version</code>: Which version of the source map spec this map is following.</p>
</li>
<li><p><code>sources</code>: An array of URLs to the original source files.</p>
</li>
<li><p><code>names</code>: An array of identifiers which can be referrenced by individual<br>mappings.</p>
</li>
<li><p><code>sourceRoot</code>: Optional. The URL root from which all sources are relative.</p>
</li>
<li><p><code>sourcesContent</code>: Optional. An array of contents of the original source files.</p>
</li>
<li><p><code>mappings</code>: A string of base64 VLQs which contain the actual mappings.</p>
</li>
<li><p><code>file</code>: Optional. The generated filename this source map is associated with.</p>
</li>
</ul>
<h4 id="SourceMapConsumer-prototype-computeColumnSpans()">SourceMapConsumer.prototype.computeColumnSpans()</h4><p>Compute the last column for each generated mapping. The last column is<br>inclusive.</p>
<h4 id="SourceMapConsumer-prototype-originalPositionFor(generatedPosition)">SourceMapConsumer.prototype.originalPositionFor(generatedPosition)</h4><p>Returns the original source, line, and column information for the generated<br>source’s line and column positions provided. The only argument is an object with<br>the following properties:</p>
<ul>
<li><p><code>line</code>: The line number in the generated source.</p>
</li>
<li><p><code>column</code>: The column number in the generated source.</p>
</li>
<li><p><code>bias</code>: Either <code>SourceMapConsumer.GREATEST_LOWER_BOUND</code> or<br><code>SourceMapConsumer.LEAST_UPPER_BOUND</code>. Specifies whether to return the closest<br>element that is smaller than or greater than the one we are searching for,<br>respectively, if the exact element cannot be found.  Defaults to<br><code>SourceMapConsumer.GREATEST_LOWER_BOUND</code>.</p>
</li>
</ul>
<p>and an object is returned with the following properties:</p>
<ul>
<li><p><code>source</code>: The original source file, or null if this information is not<br>available.</p>
</li>
<li><p><code>line</code>: The line number in the original source, or null if this information is<br>not available.</p>
</li>
<li><p><code>column</code>: The column number in the original source, or null or null if this<br>information is not available.</p>
</li>
<li><p><code>name</code>: The original identifier, or null if this information is not available.</p>
</li>
</ul>
<h4 id="SourceMapConsumer-prototype-generatedPositionFor(originalPosition)">SourceMapConsumer.prototype.generatedPositionFor(originalPosition)</h4><p>Returns the generated line and column information for the original source,<br>line, and column positions provided. The only argument is an object with<br>the following properties:</p>
<ul>
<li><p><code>source</code>: The filename of the original source.</p>
</li>
<li><p><code>line</code>: The line number in the original source.</p>
</li>
<li><p><code>column</code>: The column number in the original source.</p>
</li>
</ul>
<p>and an object is returned with the following properties:</p>
<ul>
<li><p><code>line</code>: The line number in the generated source, or null.</p>
</li>
<li><p><code>column</code>: The column number in the generated source, or null.</p>
</li>
</ul>
<h4 id="SourceMapConsumer-prototype-allGeneratedPositionsFor(originalPosition)">SourceMapConsumer.prototype.allGeneratedPositionsFor(originalPosition)</h4><p>Returns all generated line and column information for the original source,<br>line, and column provided. If no column is provided, returns all mappings<br>corresponding to a single line. Otherwise, returns all mappings corresponding to<br>a single line and column.</p>
<p>The only argument is an object with the following properties:</p>
<ul>
<li><p><code>source</code>: The filename of the original source.</p>
</li>
<li><p><code>line</code>: The line number in the original source.</p>
</li>
<li><p><code>column</code>: Optional. The column number in the original source.</p>
</li>
</ul>
<p>and an array of objects is returned, each with the following properties:</p>
<ul>
<li><p><code>line</code>: The line number in the generated source, or null.</p>
</li>
<li><p><code>column</code>: The column number in the generated source, or null.</p>
</li>
</ul>
<h4 id="SourceMapConsumer-prototype-sourceContentFor(source[,_returnNullOnMissing])">SourceMapConsumer.prototype.sourceContentFor(source[, returnNullOnMissing])</h4><p>Returns the original source content for the source provided. The only<br>argument is the URL of the original source file.</p>
<p>If the source content for the given source is not found, then an error is<br>thrown. Optionally, pass <code>true</code> as the second param to have <code>null</code> returned<br>instead.</p>
<h4 id="SourceMapConsumer-prototype-eachMapping(callback,_context,_order)">SourceMapConsumer.prototype.eachMapping(callback, context, order)</h4><p>Iterate over each mapping between an original source/line/column and a<br>generated line/column in this source map.</p>
<ul>
<li><p><code>callback</code>: The function that is called with each mapping. Mappings have the<br>form <code>{ source, generatedLine, generatedColumn, originalLine, originalColumn,
name }</code></p>
</li>
<li><p><code>context</code>: Optional. If specified, this object will be the value of <code>this</code><br>every time that <code>callback</code> is called.</p>
</li>
<li><p><code>order</code>: Either <code>SourceMapConsumer.GENERATED_ORDER</code> or<br><code>SourceMapConsumer.ORIGINAL_ORDER</code>. Specifies whether you want to iterate over<br>the mappings sorted by the generated file’s line/column order or the<br>original’s source/line/column order, respectively. Defaults to<br><code>SourceMapConsumer.GENERATED_ORDER</code>.</p>
</li>
</ul>
<h3 id="SourceMapGenerator">SourceMapGenerator</h3><p>An instance of the SourceMapGenerator represents a source map which is being<br>built incrementally.</p>
<h4 id="new_SourceMapGenerator([startOfSourceMap])">new SourceMapGenerator([startOfSourceMap])</h4><p>You may pass an object with the following properties:</p>
<ul>
<li><p><code>file</code>: The filename of the generated source that this source map is<br>associated with.</p>
</li>
<li><p><code>sourceRoot</code>: A root for all relative URLs in this source map.</p>
</li>
<li><p><code>skipValidation</code>: Optional. When <code>true</code>, disables validation of mappings as<br>they are added. This can improve performance but should be used with<br>discretion, as a last resort. Even then, one should avoid using this flag when<br>running tests, if possible.</p>
</li>
</ul>
<h4 id="SourceMapGenerator-fromSourceMap(sourceMapConsumer)">SourceMapGenerator.fromSourceMap(sourceMapConsumer)</h4><p>Creates a new SourceMapGenerator based on a SourceMapConsumer</p>
<ul>
<li><code>sourceMapConsumer</code> The SourceMap.</li>
</ul>
<h4 id="SourceMapGenerator-prototype-addMapping(mapping)">SourceMapGenerator.prototype.addMapping(mapping)</h4><p>Add a single mapping from original source line and column to the generated<br>source’s line and column for this source map being created. The mapping object<br>should have the following properties:</p>
<ul>
<li><p><code>generated</code>: An object with the generated line and column positions.</p>
</li>
<li><p><code>original</code>: An object with the original line and column positions.</p>
</li>
<li><p><code>source</code>: The original source file (relative to the sourceRoot).</p>
</li>
<li><p><code>name</code>: An optional original token name for this mapping.</p>
</li>
</ul>
<h4 id="SourceMapGenerator-prototype-setSourceContent(sourceFile,_sourceContent)">SourceMapGenerator.prototype.setSourceContent(sourceFile, sourceContent)</h4><p>Set the source content for an original source file.</p>
<ul>
<li><p><code>sourceFile</code> the URL of the original source file.</p>
</li>
<li><p><code>sourceContent</code> the content of the source file.</p>
</li>
</ul>
<h4 id="SourceMapGenerator-prototype-applySourceMap(sourceMapConsumer[,_sourceFile[,_sourceMapPath]])">SourceMapGenerator.prototype.applySourceMap(sourceMapConsumer[, sourceFile[, sourceMapPath]])</h4><p>Applies a SourceMap for a source file to the SourceMap.<br>Each mapping to the supplied source file is rewritten using the<br>supplied SourceMap. Note: The resolution for the resulting mappings<br>is the minimium of this map and the supplied map.</p>
<ul>
<li><p><code>sourceMapConsumer</code>: The SourceMap to be applied.</p>
</li>
<li><p><code>sourceFile</code>: Optional. The filename of the source file.<br>If omitted, sourceMapConsumer.file will be used, if it exists.<br>Otherwise an error will be thrown.</p>
</li>
<li><p><code>sourceMapPath</code>: Optional. The dirname of the path to the SourceMap<br>to be applied. If relative, it is relative to the SourceMap.</p>
<p>This parameter is needed when the two SourceMaps aren’t in the same<br>directory, and the SourceMap to be applied contains relative source<br>paths. If so, those relative source paths need to be rewritten<br>relative to the SourceMap.</p>
<p>If omitted, it is assumed that both SourceMaps are in the same directory,<br>thus not needing any rewriting. (Supplying <code>&#39;.&#39;</code> has the same effect.)</p>
</li>
</ul>
<h4 id="SourceMapGenerator-prototype-toString()">SourceMapGenerator.prototype.toString()</h4><p>Renders the source map being generated to a string.</p>
<h3 id="SourceNode">SourceNode</h3><p>SourceNodes provide a way to abstract over interpolating and/or concatenating<br>snippets of generated JavaScript source code, while maintaining the line and<br>column information associated between those snippets and the original source<br>code. This is useful as the final intermediate representation a compiler might<br>use before outputting the generated JS and source map.</p>
<h4 id="new_SourceNode([line,_column,_source[,_chunk[,_name]]])">new SourceNode([line, column, source[, chunk[, name]]])</h4><ul>
<li><p><code>line</code>: The original line number associated with this source node, or null if<br>it isn’t associated with an original line.</p>
</li>
<li><p><code>column</code>: The original column number associated with this source node, or null<br>if it isn’t associated with an original column.</p>
</li>
<li><p><code>source</code>: The original source’s filename; null if no filename is provided.</p>
</li>
<li><p><code>chunk</code>: Optional. Is immediately passed to <code>SourceNode.prototype.add</code>, see<br>below.</p>
</li>
<li><p><code>name</code>: Optional. The original identifier.</p>
</li>
</ul>
<h4 id="SourceNode-fromStringWithSourceMap(code,_sourceMapConsumer[,_relativePath])">SourceNode.fromStringWithSourceMap(code, sourceMapConsumer[, relativePath])</h4><p>Creates a SourceNode from generated code and a SourceMapConsumer.</p>
<ul>
<li><p><code>code</code>: The generated code</p>
</li>
<li><p><code>sourceMapConsumer</code> The SourceMap for the generated code</p>
</li>
<li><p><code>relativePath</code> The optional path that relative sources in <code>sourceMapConsumer</code><br>should be relative to.</p>
</li>
</ul>
<h4 id="SourceNode-prototype-add(chunk)">SourceNode.prototype.add(chunk)</h4><p>Add a chunk of generated JS to this source node.</p>
<ul>
<li><code>chunk</code>: A string snippet of generated JS code, another instance of<br> <code>SourceNode</code>, or an array where each member is one of those things.</li>
</ul>
<h4 id="SourceNode-prototype-prepend(chunk)">SourceNode.prototype.prepend(chunk)</h4><p>Prepend a chunk of generated JS to this source node.</p>
<ul>
<li><code>chunk</code>: A string snippet of generated JS code, another instance of<br> <code>SourceNode</code>, or an array where each member is one of those things.</li>
</ul>
<h4 id="SourceNode-prototype-setSourceContent(sourceFile,_sourceContent)">SourceNode.prototype.setSourceContent(sourceFile, sourceContent)</h4><p>Set the source content for a source file. This will be added to the<br><code>SourceMap</code> in the <code>sourcesContent</code> field.</p>
<ul>
<li><p><code>sourceFile</code>: The filename of the source file</p>
</li>
<li><p><code>sourceContent</code>: The content of the source file</p>
</li>
</ul>
<h4 id="SourceNode-prototype-walk(fn)">SourceNode.prototype.walk(fn)</h4><p>Walk over the tree of JS snippets in this node and its children. The walking<br>function is called once for each snippet of JS and is passed that snippet and<br>the its original associated source’s line/column location.</p>
<ul>
<li><code>fn</code>: The traversal function.</li>
</ul>
<h4 id="SourceNode-prototype-walkSourceContents(fn)">SourceNode.prototype.walkSourceContents(fn)</h4><p>Walk over the tree of SourceNodes. The walking function is called for each<br>source file content and is passed the filename and source content.</p>
<ul>
<li><code>fn</code>: The traversal function.</li>
</ul>
<h4 id="SourceNode-prototype-join(sep)">SourceNode.prototype.join(sep)</h4><p>Like <code>Array.prototype.join</code> except for SourceNodes. Inserts the separator<br>between each of this source node’s children.</p>
<ul>
<li><code>sep</code>: The separator.</li>
</ul>
<h4 id="SourceNode-prototype-replaceRight(pattern,_replacement)">SourceNode.prototype.replaceRight(pattern, replacement)</h4><p>Call <code>String.prototype.replace</code> on the very right-most source snippet. Useful<br>for trimming whitespace from the end of a source node, etc.</p>
<ul>
<li><p><code>pattern</code>: The pattern to replace.</p>
</li>
<li><p><code>replacement</code>: The thing to replace the pattern with.</p>
</li>
</ul>
<h4 id="SourceNode-prototype-toString()">SourceNode.prototype.toString()</h4><p>Return the string representation of this source node. Walks over the tree and<br>concatenates all the various snippets together to one string.</p>
<h4 id="SourceNode-prototype-toStringWithSourceMap([startOfSourceMap])">SourceNode.prototype.toStringWithSourceMap([startOfSourceMap])</h4><p>Returns the string representation of this tree of source nodes, plus a<br>SourceMapGenerator which contains all the mappings between the generated and<br>original sources.</p>
<p>The arguments are the same as those to <code>new SourceMapGenerator</code>.</p>
<h2 id="Tests">Tests</h2><p><a href="https://travis-ci.org/mozilla/source-map"><img src="https://travis-ci.org/mozilla/source-map.png?branch=master" alt="Build Status"></a></p>
<p>Install NodeJS version 0.8.0 or greater, then run <code>node test/run-tests.js</code>.</p>
<p>To add new tests, create a new file named <code>test/test-&lt;your new test name&gt;.js</code><br>and export your test functions with names that start with “test”, for example</p>
<pre><code class="js">exports[<span class="string">"test doing the foo bar"</span>] = <span class="function"><span class="keyword">function</span> (<span class="params">assert, util</span>) </span>{
  ...
};
</code></pre>
<p>The new test will be located automatically when you run the suite.</p>
<p>The <code>util</code> argument is the test utility module located at <code>test/source-map/util</code>.</p>
<p>The <code>assert</code> argument is a cut down version of node’s assert module. You have<br>access to the following assertion functions:</p>
<ul>
<li><p><code>doesNotThrow</code></p>
</li>
<li><p><code>equal</code></p>
</li>
<li><p><code>ok</code></p>
</li>
<li><p><code>strictEqual</code></p>
</li>
<li><p><code>throws</code></p>
</li>
</ul>
<p>(The reason for the restricted set of test functions is because we need the<br>tests to run inside Firefox’s test suite as well and so the assert module is<br>shimmed in that environment. See <code>build/assert-shim.js</code>.)</p>
